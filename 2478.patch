From 75fdafef416667575217b08be5e928f7ad887580 Mon Sep 17 00:00:00 2001
From: Dave Dykstra <2129743+DrDaveD@users.noreply.github.com>
Date: Mon, 17 Dec 2018 11:46:32 -0600
Subject: [PATCH 1/3] exclude ppc64

---
 dist/rpm/singularity.spec.in | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/dist/rpm/singularity.spec.in b/dist/rpm/singularity.spec.in
index 4c4d0f6d6..e1e3620b6 100644
--- a/dist/rpm/singularity.spec.in
+++ b/dist/rpm/singularity.spec.in
@@ -54,6 +54,8 @@ Requires: squashfs
 Requires: squashfs-tools
 %endif
 
+# there's no golang for ppc64, just ppc64le
+ExcludeArch: ppc64
 
 Provides: %{name}-runtime
 Obsoletes: %{name}-runtime

From 8be4660c9d6a8dbf33961b0f3f2bed8e81987aaf Mon Sep 17 00:00:00 2001
From: Dave Dykstra <2129743+DrDaveD@users.noreply.github.com>
Date: Mon, 17 Dec 2018 11:47:05 -0600
Subject: [PATCH 2/3] prevent failure when architecture unrecognized

---
 mlocal/checks/basechecks.chk | 12 ++++--------
 1 file changed, 4 insertions(+), 8 deletions(-)

diff --git a/mlocal/checks/basechecks.chk b/mlocal/checks/basechecks.chk
index d9c546ce7..d40790934 100644
--- a/mlocal/checks/basechecks.chk
+++ b/mlocal/checks/basechecks.chk
@@ -270,8 +270,7 @@ if [ "$hst_arch" != "" ]; then
 	echo $hst_arch
 else
 	echo "not found!"
-	usage
-	exit 1
+	hst_arch=unknown
 fi
 
 
@@ -301,8 +300,7 @@ if [ "$tgt_arch" != "" ]; then
 	echo $tgt_arch
 else
 	echo "not found!"
-	usage
-	exit 1
+	tgt_arch=unknown
 fi
 
 
@@ -333,8 +331,7 @@ if [ "$hst_word" != "" ]; then
 	echo $hst_word
 else
 	echo "not found!"
-	usage
-	exit 1
+	hst_word=unknown
 fi
 
 
@@ -364,8 +361,7 @@ if [ "$tgt_word" != "" ]; then
 	echo $tgt_word
 else
 	echo "not found!"
-	usage
-	exit 1
+	tgt_word=unknown
 fi
 
 

From 7a478a4fabe9e4585a367cf26797668712d6516a Mon Sep 17 00:00:00 2001
From: Dave Dykstra <2129743+DrDaveD@users.noreply.github.com>
Date: Mon, 7 Jan 2019 16:29:32 -0600
Subject: [PATCH 3/3] use Dup3 instead of Dup2, missing on aarch64

---
 internal/pkg/runtime/engines/singularity/process.go | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/internal/pkg/runtime/engines/singularity/process.go b/internal/pkg/runtime/engines/singularity/process.go
index f7eb2c91a..0fc00d846 100644
--- a/internal/pkg/runtime/engines/singularity/process.go
+++ b/internal/pkg/runtime/engines/singularity/process.go
@@ -153,7 +153,7 @@ func (engine *EngineOperations) StartProcess(masterConn net.Conn) error {
 					continue
 				}
 				syscall.Close(fd)
-				syscall.Dup2(consfd, fd)
+				syscall.Dup3(consfd, fd, 0)
 			}
 			consfile.Close()
 			break
